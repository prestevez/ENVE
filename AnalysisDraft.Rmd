---
title: "Statistical Analysis"
author: "Patricio R. Estevez Soto"
date: "June 24 2015"
output:
  html_document:
    highlight: pygments
    keep_md: yes
    theme: spacelab
  pdf_document: default
---

Overview of the statistical procedure to analyse repeat extortion victimisation.

The data used comes from the household victimisation surveys. The dependent variable is the count of extortion victimisations for each household, while the independent variables are other illustrative variables selected to test the scripts. The names were changed to reflect how the analyses might look.

```{r, message=FALSE, warning=FALSE}
library(xtable)
library(MASS)
library(ggplot2)
# library(knitr)
# # install.packages("gmodels")
# library(gmodels)
# # install.packages("Hmisc")
# library(Hmisc)
# # install.packages("vcd")
# library(vcd)
# # install.packages("fitdistrplus")
# library(fitdistrplus)
# # install.packages("gamlss")
# library(gamlss)
# # install.packages("VGAM")
# library(VGAM)
```

```{r}
load(file="~/R\ Workspace/ENVE/RData/b_test.Rdata")
str(b_test) # Type of variables
```

## EDA

### Dependent variable

```{r, echo=FALSE}
freq_tab <- data.frame(table(b_test$extortions))
colnames(freq_tab)[1] <- "Events"
freq_tab$Events <- as.integer(as.character(freq_tab$Events))
freq_tab$crimes <-freq_tab$Freq * freq_tab$Events
freq_tab$per_person <- prop.table(freq_tab$Freq)*100
freq_tab$per_crimes <- prop.table(freq_tab$crimes)*100
```

The distribution of extortion events. As it can be seen, the crime has a characteristic distribution with a long tail. As expected, a small subset of the population experiences a disproportionate ammount of crime. 

```{r, results='asis'}
print(xtable(freq_tab, digits=c(0,0,0,0,4,4)), type="html")
```

```{r, echo=FALSE}
Obs <- data.frame(Events=freq_tab$Events, Freq=freq_tab$Freq)
obs_exp <- data.frame(Events=0:30)
obs_exp <- merge(obs_exp, Obs, by="Events", all.x=TRUE)
obs_exp[is.na(obs_exp[,2]),2] <- 0
```

```{r}
ggplot(obs_exp, aes(x=Events, y=Freq)) + geom_bar(stat="identity") +
  ylab("Frequency") + ggtitle("Observed distribution of extortion")
```

We try plotting on a log scale to facilitate visualisation. Since there are many zeros, a convenience function `clog` is used to properly display the zeros:

```{r}
clog <- function(x) log(x + 1)
```

```{r}
ggplot(obs_exp, aes(x=Events, y=clog(Freq))) + geom_bar(stat="identity") +
  ylab("log(Frequency + 1)") + ggtitle("Observed distribution of extortion (log scale)")
```

##### Poisson test

Testing if the distribution was generated by a Poisson process.

Frist we find evidence of overdisperison by examining the mean and variance; the variance is more than two times the mean. In a Poisson distribution, the mean is equal to the variance.

```{r}
mean_ext <- mean(b_test$extortions)
var_ext <- var(b_test$extortions)
data.frame(mean_ext, var_ext, ratio=var_ext/mean_ext)
```

```{r, echo=FALSE}
# Function to find the max likelihood of k in negative binomial distributions
kfit <- function(x) { 
  lhs <- numeric() 
  rhs <- numeric() 
  y <- 0:(length(x) - 1) 
  j <- 0:(length(x)-2) 
  m <- sum(x * y)/(sum(x)) 
  s2 <- (sum(x * y^2) - sum(x * y)^2/sum(x))/(sum(x)- 1) 
  k1 <- m^2/(s2 - m) 
  a <- numeric(length(x)-1)
  for(i in 1:(length(x) - 1))  a[i] <- sum(x [- c(1:i)]) 
  i <- 0 
  for (k in seq(k1/1.2,2*k1,0.001)) {
    i <- i+1 
    lhs[i] <- sum(x) * log(1 + m/k) 
    rhs[i] <- sum(a/(k + j))  
    }
  k <- seq(k1/1.2,2*k1,0.001) 
  plot(k, abs(lhs-rhs),xlab="k",ylab="Difference",type="l",col="red") 
  d <- min(abs(lhs-rhs)) 
  sdd <- which(abs(lhs-rhs)==d) 
  k[sdd] 
}

# Function to generate a probability distribution under the negative binomial distribution
negbin <- function(x,u,k)
  {(1+u/k)^(-k)*(u/(u+k))^x*gamma(k+x)/(factorial(x)*gamma(k))}

## Function to print table with obs and exp and chi-sq test

obs_exp_test <- function(dataframe, exp, par)
  {
  cs<-factor(0:30)
  index <- max(which(exp >= 4))
  levels(cs)[index:31] <- paste(as.character(index-1), "+", sep="") 
  ef<-as.vector(tapply(exp,cs,sum))
  of<-as.vector(tapply(dataframe[,2],cs,sum))
  ofef_table <- data.frame(Events=0:(index-1), Obs=of, Exp=ef)
  chisq_t <- sum((of-ef)^2/ef)
  df <- length(of)-par-1
  pval <- 1-pchisq(chisq_t, df)  
  return(list(Table=ofef_table, Chisq=chisq_t, DF=df, PValue=pval))
  }

## Same as above but on log scale

obs_exp_test_log <- function(dataframe, exp, par)
  {
  cs<-factor(0:30)
  index <- max(which(exp >= 4))
  levels(cs)[index:31] <- paste(as.character(index-1), "+", sep="") 
  ef<-as.vector(tapply(exp,cs,sum))
  of<-as.vector(tapply(dataframe[,2],cs,sum))
  ofef_table <- data.frame(Events=0:(index-1), log.Obs=clog(of), log.Exp=clog(ef))
  chisq_t <- sum((clog(of)-clog(ef))^2/clog(ef))
  df <- length(of)-par-1
  pval <- 1-pchisq(chisq_t, df)  
  return(list(Table=ofef_table, Chisq=chisq_t, DF=df, PValue=pval))
  }

```

Next we generate a set of expected frequencies under a Poisson distribution with lambda equal to the mean of our observed distribution. If the observed data was generated by a Poisson process (i.e., it is random and independent), the Chi-square between the observed and expected frequencies should be small and should correspond to a p-value larger that 0.05. 

```{r}
# Generating the expected frequencies under Poisson
exp_po <- dpois(0:30, lambda=mean_ext)*length(b_test$extortions)
df_exp_po <- data.frame(Events=0:30, Expected=exp_po)
```

We generate plots of the expected frequencies (true and log-scale). 

```{r}
# Plots
ggplot(df_exp_po, aes(x=Events, y=Expected)) + geom_bar(stat="identity") + 
  ggtitle("Expected distribution of extortion (Poisson)")

## Plotting in a log scale
ggplot(df_exp_po, aes(x=Events, y=clog(Expected))) + geom_bar(stat="identity") + 
  ggtitle("Expected distribution of extortion (Poisson) (log scale)") +
  ylab("log(Frequency + 1)")
```

Perform a Chi-square test of of observed vs. expected frequencies under poisson. The distributions are collapsed to obtain counts of more than 4 to conform with the assumptions of the Chi-square test. 

```{r}
## Chi-sq test of the observed vs expected frequencies
po_chsq <- obs_exp_test(obs_exp, exp_po, 1)
```

```{r, results='asis'}
print(xtable(po_chsq$Table), type="html")
```

```{r}
po_chsq[2:4]
```

We perform the test using a log scale for the frequency.

```{r}
## Using a log scale
po_chsq_log <- obs_exp_test_log(obs_exp, exp_po, 1)
```

```{r, results='asis'}
print(xtable(po_chsq_log$Table), type="html")
```

```{r}
po_chsq_log[2:4]
```

##### Negative binomial test

If our distribution was statistically different from a Poisson distribution, and if overdispersion is present, we can assume that the data follows a negative binomial distribution. However, we can also test if this dsitribution fits the data. In addition to the mu parameter (the mean of the observed values), we must calculate a k parameter which accounts for the overdispersion in the distribution. 

```{r}
# calculating the k paramater needed for the negative binomial distribution, using max likelihood

k_ml <- kfit(obs_exp$Freq)

# generating the probability distribution and the expected frequencies under the negative binomial distribution

mean_ext
k_ml

xf <- sapply(0:30, function(i) negbin(i,mean_ext,k_ml))

exp_nb <- xf*length(b_test$extortions)

df_exp_nb <- data.frame(Events=0:30, Expected=exp_nb)
```

We generate plots of the expected frequencies (true and log-scale). 

```{r}
# Plots
ggplot(df_exp_nb, aes(x=Events, y=Expected)) + geom_bar(stat="identity") + 
  ggtitle("Expected distribution of extortion (Negative binomial)")

## Plotting in a log scale
ggplot(df_exp_nb, aes(x=Events, y=clog(Expected))) + geom_bar(stat="identity") + 
  ggtitle("Expected distribution of extortion (Negative binomial) (log scale)") +
  ylab("log(Frequency + 1)")
```

We perform a Chi-square test of of observed vs. expected frequencies under the negative binomial. The distributions are collapsed to obtain counts of more than 4 to conform with the assumptions of the Chi-square test. If the distributions are similar, we should obtain a p-value larger that 0.5.


```{r}
## Chi-sq test of the observed vs expected frequencies
nb_chsq <- obs_exp_test(obs_exp, exp_nb, 2)

```

```{r, results='asis'}
print(xtable(nb_chsq$Table), type="html")
```

```{r}
nb_chsq[2:4]
```

We perform the test using a log scale in the frequency.

```{r}
## Using a log scale
nb_chsq_log <- obs_exp_test_log(obs_exp, exp_nb, 2)
```

```{r, results='asis'}
print(xtable(nb_chsq_log$Table), type="html")
```

```{r}
nb_chsq_log[2:4]
```

### Independent variables

We now describe the independent variables.

```{r, echo=FALSE}
homicidios <- read.csv("~/R\ Workspace/ENVE/ENVIPE/homicidios_tasas_2013.csv", header=T)

homicidios <- merge(homicidios, cat_entidades, by="CVE_ENT")

homicidios <- homicidios[,-2]
```

```{r, echo=FALSE}
summ_table <- data.frame(variable=0, obs=0, incidence=0, mean=0, sd=0, var=0)

ind <- 1
for (i in 1:length(b_test))
  {
  if (i <= 2)
    {
    summ_table[ind,1] <- colnames(b_test)[i]
    summ_table[ind,2] <- length(b_test[b_test[,i] != 0,i])
    summ_table[ind,3] <- sum(b_test[,i])
    summ_table[ind,4] <- mean(b_test[,i])
    summ_table[ind,5] <- sd(b_test[,i])
    summ_table[ind,6] <- var(b_test[,i])
    }

  else if (colnames(b_test)[i] == "years")
    {
    summ_table[ind,1] <- colnames(b_test)[i]
    summ_table[ind,2] <- length(b_test[b_test[,i] != 0,i])
    summ_table[ind,4] <- mean(b_test[,i])
    summ_table[ind,5] <- sd(b_test[,i])
    summ_table[ind,6] <- var(b_test[,i])
    }
  
  else if (i >= 7)
    {
    for (a in 1:length(levels(b_test[,i])))
      {
      summ_table[ind,1] <- levels(b_test[,i])[a]
      summ_table[ind,2] <- length(b_test[b_test[,i]== levels(b_test[,i])[a],i])
      summ_table[ind,4] <- summ_table[ind,2]/length(b_test[,1])
      ind <- ind + 1
      }
    }
  ind <- ind + 1
  }


summ_table <- summ_table[!is.na(summ_table[,1]),]

summ_table[length(summ_table[,1])+1,] <- c(0, length(homicidios[,4]), NA, 
                      mean(homicidios[,4]), sd(homicidios[,4]), var(homicidios[,4]))

summ_table[,4:6] <- round(summ_table[,4:6],3)

summ_table[12,1] <- "state murder rt"

```

```{r, results='asis'}
print(xtable(summ_table, digits=c(0,0,0,0,3,3,3)), type="html")
```

#### Bribes variable

```{r, echo=FALSE}
bribes_tab <- data.frame(table(b_test$bribes))
bribes <- data.frame(Events=bribes_tab$Var1, Freq=bribes_tab$Freq)
colnames(bribes)[1] <- "Events"
bribes$Events <- as.integer(as.character(bribes$Events))
obs_b <- data.frame(Events=0:max(bribes$Events))
bribes <- merge(bribes, obs_b, by="Events", all.y=TRUE)
bribes[is.na(bribes[,2]),2] <- 0
```

Plot of the distribution of bribes

```{r}
ggplot(bribes, aes(x=Events, y=Freq)) + geom_bar(stat="identity") +
  ylab("Frequency") + ggtitle("Observed distribution of bribes")

# Plot in in the log scale
ggplot(bribes, aes(x=Events, y=clog(Freq))) + geom_bar(stat="identity") +
  ylab("log(Frequency + 1)") + ggtitle("Observed distribution of bribes")
```

Examining the relationship between extortions and bribes.

```{r, echo=FALSE}
ext_bribes <- with(b_test, table(bribes, extortions))
for (i in 7:length(colnames(ext_bribes)))
  {
  ext_bribes[,6] <- ext_bribes[,6] + ext_bribes[,i]
  }
for (i in 7:length(rownames(ext_bribes)))
  {
  ext_bribes[6,] <- ext_bribes[6,] + ext_bribes[i,] 
  }
ext_bribes <- ext_bribes[1:6,1:6]
colnames(ext_bribes)[6] <- "5+"
rownames(ext_bribes)[6] <- "5+"
```

```{r, results='asis'}
print(xtable(ext_bribes), type="html")
print(xtable(prop.table(ext_bribes), digits=3), type="html")
```

```{r}
chisq.test(ext_bribes)

# Contingency table assuming Poisson process for both variables
ext_rpo <- rpois(length(b_test$extortions), lambda=mean_ext)
brb_rpo <- rpois(length(b_test$bribes), lambda=mean(b_test$bribes))
ext_bribes_rpo <- table(brb_rpo, ext_rpo)

ext_bribes_rpo <- rbind(ext_bribes_rpo, "4"=0, "5+"=0)
ext_bribes_rpo <- cbind(ext_bribes_rpo, "4"=0, "5+"=0)

chisq.test(ext_bribes, p=prop.table(ext_bribes_rpo))
```

```{r, results='asis'}
print(xtable(ext_bribes_rpo), type="html")
print(xtable(prop.table(ext_bribes_rpo), digits=3), type="html")
```

```{r}
# Contingency table of expected counts under Poisson
mar.b <- margin.table(ext_bribes_rpo,1)
mar.e <- margin.table(ext_bribes_rpo,2)
mar.t <- margin.table(ext_bribes_rpo)

mars <- matrix(0,6,6)
for (i in 1:length(mar.b))
  {
  for (j in 1:length(mar.e))
    {
    mars[i,j] <- (mar.b[i]/mar.t)*(mar.e[j]/mar.t)
    }
  }

chisq.test(ext_bribes, p=mars)
```

```{r, results='asis'}
print(xtable(mars, digits=3), type="html")
print(xtable(mars*mar.t, digits=3), type="html")
```

A plot and a correlation test shows if the variables are associated.

```{r}
ggplot(b_test, aes(x=bribes, y=extortions)) + geom_jitter() + geom_smooth(method="lm") +
  ggtitle("Bribes vs. extortion events") + scale_x_continuous(breaks=0:12) + 
  ylab("Extortion events") + xlab("Bribes")

cor.test(b_test$bribes, y=b_test$extortions, method="pearson")
```

#### Years
```{r, echo=FALSE}
ext_years <- with(b_test, table(cut(years, breaks=c(0,5,10,15,20,25), right=FALSE),
                                extortions))
for (i in 7:length(colnames(ext_years)))
  {
  ext_years[,6] <- ext_years[,6] + ext_years[,i]
  }
ext_years <- ext_years[,1:6]
colnames(ext_years)[6] <- "5+"
rownames(ext_years) <- c("0-4", "5-9", "10-14", "15-19", "20+")
```

```{r, results='asis'}
print(xtable(ext_years), type="html")
```


```{r, echo=FALSE}
ey_df <- matrix(0,nrow(ext_years)+ncol(ext_years),3)
ey_df <- as.data.frame(ey_df)
colnames(ey_df) <- c("Events", "Freq", "Years")
ind <- 1
for (i in 1:ncol(ext_years))
  {
  for (j in 1:nrow(ext_years))
    {
    ey_df[ind,1] <- colnames(ext_years)[i]
    ey_df[ind,2] <- ext_years[j,i]
    ey_df[ind,3] <- rownames(ext_years)[j]
    ind <- ind + 1
    }
  }
```

```{r}
chisq.test(ext_years)
ggplot(ey_df, aes(x=Events, y=clog(Freq), fill=Years)) + 
  geom_bar(stat="identity") +
  facet_grid(Years~., scale="free") +
  ylab("log(Frequency + 1)") +
  ggtitle("Extortion events by enterprise age range")


ggplot(b_test, aes(x=years, y=extortions)) + geom_jitter() + geom_smooth(method="lm") +
  ggtitle("Extortions by enterprise age")

with(b_test, cor.test(extortions, years))

```


#### Sector
```{r, echo=FALSE}
ext_sector <- with(b_test, table(sector , extortions))

for (i in 7:length(colnames(ext_sector)))
  {
  ext_sector[,6] <- ext_sector[,6] + ext_sector[,i]
  }
ext_sector <- ext_sector[,1:6]
colnames(ext_sector)[6] <- "5+"
```

```{r, results='asis'}
print(xtable(ext_sector), type="html")
```


```{r, echo=FALSE}
es_df <- matrix(0,nrow(ext_sector)+ncol(ext_sector),3)
es_df <- as.data.frame(es_df)
colnames(es_df) <- c("Events", "Freq", "Sector")
ind <- 1
for (i in 1:ncol(ext_sector))
  {
  for (j in 1:nrow(ext_sector))
    {
    es_df[ind,1] <- colnames(ext_sector)[i]
    es_df[ind,2] <- ext_sector[j,i]
    es_df[ind,3] <- rownames(ext_sector)[j]
    ind <- ind + 1
    }
  }
```

```{r}
chisq.test(ext_sector)
ggplot(es_df, aes(x=Events, y=clog(Freq), fill=Sector)) + 
  geom_bar(stat="identity") +
  facet_grid(Sector~., scale="free") +
  ylab("log(Frequency + 1)") +
  ggtitle("Extortion events by Sector")
```


#### Size
```{r, echo=FALSE}
ext_size <- with(b_test, table(size, extortions))

for (i in 7:length(colnames(ext_size)))
  {
  ext_size[,6] <- ext_size[,6] + ext_size[,i]
  }
ext_size <- ext_size[,1:6]
colnames(ext_size)[6] <- "5+"
```

```{r, results='asis'}
print(xtable(ext_size), type="html")
```


```{r, echo=FALSE}
esi_df <- matrix(0,nrow(ext_size)+ncol(ext_size),3)
esi_df <- as.data.frame(esi_df)
colnames(esi_df) <- c("Events", "Freq", "Size")
ind <- 1
for (i in 1:ncol(ext_size))
  {
  for (j in 1:nrow(ext_size))
    {
    esi_df[ind,1] <- colnames(ext_size)[i]
    esi_df[ind,2] <- ext_size[j,i]
    esi_df[ind,3] <- rownames(ext_size)[j]
    ind <- ind + 1
    }
  }
```

```{r}
chisq.test(ext_size)
ggplot(esi_df, aes(x=Events, y=clog(Freq), fill=Size)) + 
  geom_bar(stat="identity") +
  facet_grid(Size~., scale="free") +
  ylab("log(Frequency + 1)") +
  ggtitle("Extortion events by Size")
```


#### Area level influences
By state (Tables)
```{r, echo=FALSE}

state_ext <- with(b_test, table(state_code, extortions))

state_hom <- homicidios[,c(1,4,5,6)]

state_inc <- t(t(state_ext)*as.integer(colnames(state_ext)))


state_summ1 <- data.frame(data.frame(margin.table(state_ext[,2:15],1))/
                            data.frame(margin.table(state_ext[,1:15],1))*1000)

state_summ1 <- cbind(state_summ1, data.frame(margin.table(state_inc,1))[,2]/
                       data.frame(margin.table(state_ext[,1:15],1))*1000)

colnames(state_summ1) <- c("Prevalence", "Incidence")

state_summ1 <- cbind(state_summ1, 
                     Concentration=state_summ1$Incidence/state_summ1$Prevalence)

state_summ1 <- cbind(state_summ1, CVE_ENT= as.integer(rownames(state_summ1)))

state_summ1 <- merge(state_summ1, state_hom, by="CVE_ENT")
```


```{r, results='asis'}
print(xtable(state_summ1), type="html")

```

plots
```{r}

ggplot(state_summ1, aes(x=Prevalence, y=Incidence)) + geom_point() + 
  geom_smooth(method="lm")

summary(lm(Incidence~Prevalence, data=state_summ1))

with(state_summ1, cor.test(Incidence, Prevalence))

ggplot(state_summ1, aes(x=Prevalence, y=Concentration)) +
  geom_point() + geom_smooth(method="lm")

summary(lm(Concentration~Prevalence, data=state_summ1))

with(state_summ1, cor.test(Concentration, Prevalence))

ggplot(state_summ1, aes(x=tasahom, y=Concentration)) +
  geom_point() + geom_smooth(method="lm")

summary(lm(Concentration~tasahom, data=state_summ1))
with(state_summ1, cor.test(Concentration, tasahom))


ggplot(state_summ1, aes(x=tasahom, y=Incidence)) +
  geom_point() + geom_smooth(method="lm")

summary(lm(Incidence~tasahom, data=state_summ1))
with(state_summ1, cor.test(Incidence, tasahom))


ggplot(state_summ1, aes(x=tasahom, y=Prevalence)) +
  geom_point() + geom_smooth(method="lm")

summary(lm(Prevalence~tasahom, data=state_summ1))
with(state_summ1, cor.test(Prevalence, tasahom))



```


(MAPS)


## Modelling


### Poisson Model

### Quasi Poisson


### Negative Binomial

### Hurdle

### ZINB

### Comparison between models


